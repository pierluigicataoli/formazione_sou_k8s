pipeline {
    // Definizione dell'agente Kubernetes per eseguire i comandi Helm e Git
    agent {
        kubernetes {
            // Container sidecar con Helm, Kubectl e il client Docker
            yaml """
apiVersion: v1
kind: Pod
metadata:
  namespace: formazione-sou
spec:
  serviceAccountName: jenkins-sa
  containers:
  - name: jnlp
    image: jenkins/inbound-agent:latest
  - name: helm-kubectl
    image: alpine/helm:latest
    command: ['cat']
    tty: true
  - name: docker-cli 
    image: docker:20.10.16-cli 
    command: ['cat']
    tty: true
"""
            namespace 'formazione-sou' // Namespace configurato nel Cloud Jenkins
        }
    }

    // 2. Definizione delle variabili d'ambiente
    environment {
        // Namespace di destinazione nel cluster K8s
        K8S_NAMESPACE = 'formazione-sou'
        // Percorso relativo alla root del repository (il chart Ã¨ qui)
        CHART_PATH = 'charts/flask-app-chart'
        // Nome della release di Helm
        HELM_RELEASE_NAME = 'sou-app-release'
        // URL del repository GitHub
        GIT_REPO_URL = 'https://github.luigicataoli/formazione_sou_k8s.git'
        GIT_CREDENTIALS_ID = 'github-token-pierluigi'
        // Variabili necessarie per la build Docker
        IMAGE_NAME = 'flask-app-example-build'
        IMAGE_TAG = 'latest'
    }

    // 3. Stage
    stages {
        stage('Checkout & Setup') {
            steps {
                echo "Esecuzione deploy nel namespace: ${K8S_NAMESPACE}"
            }
        }

        stage('Docker Build & Load') {
            steps {
                // 1. BUILD DOCKER: Costruisce l'immagine
                container('docker-cli') {
                    sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ."
                }

                // 2. LOAD IMMAGINE: Carica l'immagine nel registry di Minikube.
                // Richiede che il client minikube sia disponibile nel path del container helm-kubectl.
                // Se fallisce, devi usare un'immagine custom per 'helm-kubectl' che includa anche 'minikube'.
                container('helm-kubectl') {
                    sh "minikube image load ${IMAGE_NAME}:${IMAGE_TAG}"
                }
            }
        }

        stage('Helm Deploy') {
            steps {
                container('helm-kubectl') {
                    // Esegue l'installazione o l'aggiornamento (upgrade) del chart Helm
                    sh """
                    helm upgrade --install \\
                        ${HELM_RELEASE_NAME} \\
                        ./${CHART_PATH} \\
                        --namespace ${K8S_NAMESPACE} \\
                        --atomic \\
                        --wait \\
                        --timeout 10m
                    """
                }
            }
        }
    }
}
